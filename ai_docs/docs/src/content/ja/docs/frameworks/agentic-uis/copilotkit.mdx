---
title: "CopilotKitとの使用"
description: "MastraがCopilotKitのAGUIライブラリをどのように活用し、ユーザーエクスペリエンスの構築にどのように活用できるかを学ぶ"
---

import { Tabs, Steps } from "nextra/components";
import Image from "next/image";



# CopilotKitをMastraと統合する

CopilotKitは、カスタマイズ可能なAIコパイロットをアプリケーションに素早く統合するためのReactコンポーネントを提供します。Mastraと組み合わせることで、双方向の状態同期とインタラクティブなUIを特徴とする洗練されたAIアプリを構築できます。

CopilotKitの概念、コンポーネント、高度な使用パターンについて詳しく学ぶには、[CopilotKitドキュメント](https://docs.copilotkit.ai/)をご覧ください。

このガイドでは、2つの異なる統合アプローチを紹介します：

1. 別のReactフロントエンドを持つMastraサーバーにCopilotKitを統合する
2. Next.jsアプリにCopilotKitを統合する



<Tabs items={["Mastra Server", "Next.js" ]}>
  <Tabs.Tab>
    <Steps>
      ## React依存関係をインストール

      Reactフロントエンドで、必要なCopilotKitパッケージをインストールします：

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/react-core @copilotkit/react-ui
          ```
        </Tabs.Tab>
      </Tabs>

      ## CopilotKitコンポーネントを作成

      Reactフロントエンドでコンポーネントを作成します：

      ```tsx filename="components/copilotkit-component.tsx" showLineNumbers copy
      import { CopilotChat } from "@copilotkit/react-ui";
      import { CopilotKit } from "@copilotkit/react-core";
      import "@copilotkit/react-ui/styles.css";

      export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
        return (
          <CopilotKit
            runtimeUrl={runtimeUrl}
            agent="weatherAgent"
          >
            <CopilotChat
              labels={{
                title: "Your Assistant",
                initial: "Hi! 👋 How can I assist you today?",
              }}
            />
          </CopilotKit>
        );
      }
      ```

      ## 依存関係をインストール

      まだMastraサーバーをセットアップしていない場合は、[はじめに](/docs/getting-started/installation)ガイドに従って新しいMastraプロジェクトをセットアップしてください。

      MastraサーバーでCopilotKit統合用の追加パッケージをインストールします：

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>
      </Tabs>

      ## Mastraサーバーを設定

      CopilotKitのランタイムエンドポイントを含むようにMastraインスタンスを設定します：

      ```typescript filename="src/mastra/index.ts" showLineNumbers copy {5-8,12-28}
      import { Mastra } from "@mastra/core/mastra";
      import { registerCopilotKit } from "@ag-ui/mastra";
      import { weatherAgent } from "./agents/weather-agent";

      type WeatherRuntimeContext = {
        "user-id": string;
        "temperature-scale": "celsius" | "fahrenheit";
      };

      export const mastra = new Mastra({
        agents: { weatherAgent },
        server: {
          cors: {
            origin: "*",
            allowMethods: ["*"],
            allowHeaders: ["*"]
          },
          apiRoutes: [
            registerCopilotKit<WeatherRuntimeContext>({
              path: "/copilotkit",
              resourceId: "weatherAgent",
              setContext: (c, runtimeContext) => {
                runtimeContext.set("user-id", c.req.header("X-User-ID") || "anonymous");
                runtimeContext.set("temperature-scale", "celsius");
              }
            })
          ]
        }
      });
      ```

      ## ReactアプリでのUsage

      MastraサーバーのURLを使用してReactアプリでコンポーネントを使用します：

      ```tsx filename="App.tsx" showLineNumbers copy {5}
      import { CopilotKitComponent } from "./components/copilotkit-component";

      function App() {
        return (
          <CopilotKitComponent runtimeUrl="http://localhost:4111/copilotkit" />
        );
      }

      export default App;
      ```
    </Steps>
  </Tabs.Tab>

  <Tabs.Tab>
    <Steps>
      ## 依存関係のインストール

      Next.jsアプリで、必要なパッケージをインストールします：

      <Tabs items={["npm", "yarn", "pnpm"]}>
        <Tabs.Tab>
          ```bash copy
          npm install @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          yarn add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ```bash copy
          pnpm add @copilotkit/react-core @copilotkit/react-ui @copilotkit/runtime @ag-ui/mastra
          ```
        </Tabs.Tab>
      </Tabs>

      ## CopilotKitコンポーネントを作成する \[#full-stack-nextjs-create-copilotkit-component]

      CopilotKitコンポーネントを作成します：

      ```tsx filename="components/copilotkit-component.tsx" showLineNumbers copy
      'use client';
      import { CopilotChat } from "@copilotkit/react-ui";
      import { CopilotKit } from "@copilotkit/react-core";
      import "@copilotkit/react-ui/styles.css";

      export function CopilotKitComponent({ runtimeUrl }: { runtimeUrl: string}) {
        return (                                                       y
          <CopilotKit
            runtimeUrl={runtimeUrl}
            agent="weatherAgent"
          >
            <CopilotChat
              labels={{
                title: "Your Assistant",
                initial: "Hi! 👋 How can I assist you today?",
              }}
            />
          </CopilotKit>
        );
      }
      ```

      ## API ルートの作成

      Next.js アプリケーションでMastraを統合する方法によって決まる、API ルートの2つのアプローチがあります。

      1. アプリにMastraのインスタンスが統合されたフルスタックNext.jsアプリの場合
      2. 別のMastraサーバーとMastra Client SDKを使用するNext.jsアプリの場合

      <Tabs items={["Mastraインスタンスを使用", "Mastra Client SDKを使用"]}>
        <Tabs.Tab>
          ローカルのMastraエージェントに接続するAPIルートを作成します。

          ```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,11-26}
          import { mastra } from "../../mastra";
          import {
            CopilotRuntime,
            ExperimentalEmptyAdapter,
            copilotRuntimeNextJSAppRouterEndpoint,
          } from "@copilotkit/runtime";
          import { MastraAgent } from "@ag-ui/mastra";
          import { NextRequest } from "next/server";

          export const POST = async (req: NextRequest) => {
            const mastraAgents = MastraAgent.getLocalAgents({
              mastra,
              agentId: "weatherAgent",
            });

            const runtime = new CopilotRuntime({
              agents: mastraAgents,
            });

            const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
              runtime,
              serviceAdapter: new ExperimentalEmptyAdapter(),
              endpoint: "/api/copilotkit",
            });

            return handleRequest(req);
          };
          ```
        </Tabs.Tab>

        <Tabs.Tab>
          ## Mastra Client SDKのインストール

          Mastra Client SDKをインストールします。

          <Tabs items={["npm", "yarn", "pnpm"]}>
            <Tabs.Tab>
              ```bash copy
              npm install @mastra/client-js
              ```
            </Tabs.Tab>

            <Tabs.Tab>
              ```bash copy
              yarn add @mastra/client-js
              ```
            </Tabs.Tab>

            <Tabs.Tab>
              ```bash copy
               pnpm add @mastra/client-js
              ```
            </Tabs.Tab>
          </Tabs>

          リモートのMastraエージェントに接続するAPIルートを作成します：

          ```typescript filename="app/api/copilotkit/route.ts" showLineNumbers copy {1-7,12-26}
          import { MastraClient } from "@mastra/client-js";
          import {
            CopilotRuntime,
            ExperimentalEmptyAdapter,
            copilotRuntimeNextJSAppRouterEndpoint,
          } from "@copilotkit/runtime";
          import { MastraAgent } from "@ag-ui/mastra";
          import { NextRequest } from "next/server";

          export const POST = async (req: NextRequest) => {
            const baseUrl = process.env.MASTRA_BASE_URL || "http://localhost:4111";
            const mastraClient = new MastraClient({ baseUrl });

            const mastraAgents = await MastraAgent.getRemoteAgents({ mastraClient });

            const runtime = new CopilotRuntime({
              agents: mastraAgents,
            });

            const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
              runtime,
              serviceAdapter: new ExperimentalEmptyAdapter(),
              endpoint: "/api/copilotkit",
            });

            return handleRequest(req);
          };
          ```
        </Tabs.Tab>
      </Tabs>

      ## コンポーネントを使用する

      ローカルAPIエンドポイントでコンポーネントを使用します：

      ```tsx filename="App.tsx" showLineNumbers copy {5}
      import { CopilotKitComponent } from "./components/copilotkit-component";

      function App() {
        return (
          <CopilotKitComponent runtimeUrl="/api/copilotkit" />
        );
      }

      export default App;
      ```
    </Steps>
  </Tabs.Tab>
</Tabs>




未来の構築を始めましょう！

<br />

<Image
  className="rounded-lg"
  src="/image/copilotkit/cpkoutput.jpg"
  alt="CopilotKit output"
  width={700}
  height={700}
/>



## 次のステップ

- [CopilotKit Documentation](https://docs.copilotkit.ai) - 完全なCopilotKitリファレンス
- [React Hooks with CopilotKit](https://docs.copilotkit.ai/reference/hooks/useCoAgent) - 高度なReact統合パターン
- [Next.js Integration with Mastra](/docs/frameworks/web-frameworks/next-js) - フルスタックNext.jsセットアップガイド
