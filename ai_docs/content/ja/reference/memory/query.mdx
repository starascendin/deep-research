---
title: "リファレンス: Memory.query() | Memory | Mastra ドキュメント"
description: "Mastra の `Memory.query()` メソッドに関するドキュメント。ページネーション、フィルター、セマンティック検索に対応し、特定のスレッドからメッセージを取得します。"
---

# Memory.query()

`.query()` メソッドは、特定のスレッドからメッセージを取得し、ページネーション、フィルターリング、セマンティック検索に対応しています。

## 使用例

```typescript copy
await memory?.query({ threadId: "user-123" });
```

## パラメータ

<PropertiesTable
  content={[
    {
      name: "threadId",
      type: "string",
      description: "メッセージを取得する対象スレッドの一意の識別子",
      isOptional: false,
    },
    {
      name: "resourceId",
      type: "string",
      description: "スレッドを所有するリソースの任意のID。指定された場合はスレッドの所有権を検証します",
      isOptional: true,
    },
    {
      name: "selectBy",
      type: "object",
      description: "メッセージのフィルタリングおよび選択用のオプション",
      isOptional: true,
    },
    {
      name: "threadConfig",
      type: "MemoryConfig",
      description: "メッセージ取得およびセマンティック検索に関する設定オプション",
      isOptional: true,
    },
    {
      name: "format",
      type: "'v1' | 'v2'",
      description: "返すメッセージのフォーマット。現在の形式には 'v2' がデフォルト、後方互換のためには 'v1' を使用します",
      isOptional: true,
    },
  ]}
/>

### selectBy パラメーター

<PropertiesTable
  content={[
    {
      name: "vectorSearchString",
      type: "string",
      description: "意味的に類似したメッセージを検索するための文字列。threadConfig で semantic recall を有効にしておく必要があります。",
      isOptional: true,
    },
    {
      name: "last",
      type: "number | false",
      description: "取得する最新メッセージの件数。制限を無効化するには false を指定します。注意: threadConfig.lastMessages（既定値: 10）がこれより小さい場合はそちらが優先されます。",
      isOptional: true,
    },
    {
      name: "include",
      type: "{ id: string; threadId?: string; withPreviousMessages?: number; withNextMessages?: number }[]",
      description: "任意のコンテキストメッセージを添えて取得する特定のメッセージ ID の配列。各要素には必須の `id`、任意の `threadId`（既定ではメインの threadId）、`withPreviousMessages`（前に含めるメッセージ数。ベクトル検索時は既定で 2、それ以外は 0）、`withNextMessages`（後に含めるメッセージ数。ベクトル検索時は既定で 2、それ以外は 0）が含まれます。",
      isOptional: true,
    },
    {
      name: "pagination",
      type: "{ dateRange?: { start?: Date; end?: Date }; page?: number; perPage?: number }",
      description: "メッセージをバッチで取得するためのページネーション設定。`dateRange`（日付範囲でのフィルター）、`page`（0 始まりのページ番号）、`perPage`（1 ページあたりのメッセージ数）を指定します。",
      isOptional: true,
    },
  ]}
/>

### threadConfig のパラメータ

<PropertiesTable
  content={[
    {
      name: "lastMessages",
      type: "number | false",
      description: "取得する最新メッセージ数。無効化する場合は false を指定します。",
      isOptional: true,
      defaultValue: "10",
    },
    {
      name: "semanticRecall",
      type: "boolean | { topK: number; messageRange: number | { before: number; after: number }; scope?: 'thread' | 'resource' }",
      description: "メッセージ履歴でのセマンティック検索を有効にします。boolean か、設定オプションを持つオブジェクトを指定できます。有効化するには、ベクターストアとエンベッダーの両方の設定が必要です。",
      isOptional: true,
      defaultValue: "false",
    },
    {
      name: "workingMemory",
      type: "WorkingMemory",
      description: "ワーキングメモリ機能の設定。`{ enabled: boolean; template?: string; schema?: ZodObject<any> | JSONSchema7; scope?: 'thread' | 'resource' }` または `{ enabled: boolean }`（無効化）を指定できます。",
      isOptional: true,
      defaultValue: "{ enabled: false, template: '# User Information\\n- **First Name**:\\n- **Last Name**:\\n...' }",
    },
    {
      name: "threads",
      type: "{ generateTitle?: boolean | { model: DynamicArgument<MastraLanguageModel>; instructions?: DynamicArgument<string> } }",
      description: "メモリスレッドの作成に関する設定。`generateTitle` はユーザーの最初のメッセージからスレッドタイトルを自動生成するかを制御します。boolean か、カスタムの model と instructions を指定するオブジェクトを渡せます。",
      isOptional: true,
      defaultValue: "{ generateTitle: false }",
    },
  ]}
/>

## 戻り値

<PropertiesTable
  content={[
    {
      name: "messages",
      type: "CoreMessage[]",
      description: "取得したメッセージをコア形式で収めた配列",
    },
    {
      name: "uiMessages",
      type: "UIMessageWithMetadata[]",
      description: "UI 表示用に整形されたメッセージの配列。ツール呼び出しとその結果のスレッド化を適切に反映",
    },
  ]}
/>

## 詳細な使用例

```typescript filename="src/test-memory.ts" showLineNumbers copy
import { mastra } from "./mastra";

const agent = mastra.getAgent("agent");
const memory = await agent.getMemory();

const { messages, uiMessages } = await memory!.query({
  threadId: "thread-123",
  selectBy: {
    last: 50,
    vectorSearchString: "What messages are there?",
    include: [
      {
        id: "msg-123"
      },
      {
        id: "msg-456",
        withPreviousMessages: 3,
        withNextMessages: 1
      }
    ]
  },
  threadConfig: {
    semanticRecall: true
  }
});

console.log(messages);
console.log(uiMessages);
```

### 関連情報

- [Memory クラス リファレンス](/reference/memory/Memory.mdx)
- [Memory の開始ガイド](/docs/memory/overview.mdx)
- [セマンティックリコール](/docs/memory/semantic-recall.mdx)
- [createThread](/reference/memory/createThread.mdx)