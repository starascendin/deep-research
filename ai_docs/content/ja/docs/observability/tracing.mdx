---
title: "トレーシング | Mastra 可観測性ドキュメント"
description: "Mastraアプリケーション用のOpenTelemetryトレーシングをセットアップする"
---

import Image from "next/image";



# トレーシング

MastraはOpenTelemetry Protocol（OTLP）をサポートしており、アプリケーションのトレーシングと監視を行うことができます。テレメトリが有効になっている場合、Mastraはエージェント操作、LLMインタラクション、ツール実行、統合呼び出し、ワークフロー実行、データベース操作を含むすべてのコアプリミティブを自動的にトレースします。テレメトリデータは任意のOTELコレクターにエクスポートできます。

### 基本設定

テレメトリを有効にする簡単な例は以下の通りです：

```ts filename="mastra.config.ts" showLineNumbers copy
export const mastra = new Mastra({
  // ... その他の設定
  telemetry: {
    serviceName: "my-app",
    enabled: true,
    sampling: {
      type: "always_on",
    },
    export: {
      type: "otlp",
      endpoint: "http://localhost:4318", // SigNozローカルエンドポイント
    },
  },
});
```

### 設定オプション

テレメトリ設定は以下のプロパティを受け入れます：

```ts
type OtelConfig = {
  // トレースでサービスを識別する名前（オプション）
  serviceName?: string;

  // テレメトリの有効/無効（デフォルトはtrue）
  enabled?: boolean;

  // サンプリングするトレースの数を制御
  sampling?: {
    type: "ratio" | "always_on" | "always_off" | "parent_based";
    probability?: number; // 比率サンプリング用
    root?: {
      probability: number; // parent_basedサンプリング用
    };
  };

  // テレメトリデータの送信先
  export?: {
    type: "otlp" | "console";
    endpoint?: string;
    headers?: Record<string, string>;
  };
};
```

詳細については、[OtelConfigリファレンスドキュメント](../../reference/observability/otel-config.mdx)を参照してください。

### 環境変数

環境変数を通じてOTLPエンドポイントとヘッダーを設定できます：

```env filename=".env" copy
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
OTEL_EXPORTER_OTLP_HEADERS=x-api-key=your-api-key
```

その後、設定で：

```ts filename="mastra.config.ts" showLineNumbers copy
export const mastra = new Mastra({
  // ... その他の設定
  telemetry: {
    serviceName: "my-app",
    enabled: true,
    export: {
      type: "otlp",
      // エンドポイントとヘッダーは環境変数から取得されます
    },
  },
});
```

### 例：SigNoz統合

[SigNoz](https://signoz.io)でトレースされたエージェントインタラクションは以下のようになります：

<img
  src="/image/signoz-telemetry-demo.png"
  alt="スパン、LLM呼び出し、ツール実行を示すエージェントインタラクショントレース"
  style={{ maxWidth: "800px", width: "100%", margin: "8px 0" }}
  className="nextra-image rounded-md"
  data-zoom
  width={800}
  height={400}
/>

### その他のサポートされているプロバイダー

サポートされている可観測性プロバイダーの完全なリストと設定の詳細については、[可観測性プロバイダーリファレンス](../../reference/observability/providers/)を参照してください。

### カスタムインストルメンテーションファイル

`/mastra`フォルダにカスタムインストルメンテーションファイルを配置することで、Mastraプロジェクトでカスタムインストルメンテーションファイルを定義できます。Mastraはこれらのファイルを自動的に検出し、デフォルトのインストルメンテーションの代わりにバンドルします。

#### サポートされているファイルタイプ

Mastraは以下の拡張子を持つインストルメンテーションファイルを探します：
- `instrumentation.js`
- `instrumentation.ts` 
- `instrumentation.mjs`

#### 例

```ts filename="/mastra/instrumentation.ts" showLineNumbers copy
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter({
    url: 'http://localhost:4318/v1/traces',
  }),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();
```

Mastraがカスタムインストルメンテーションファイルを見つけると、自動的にデフォルトのインストルメンテーションを置き換え、ビルドプロセス中にバンドルします。

### Mastraサーバー環境外でのトレーシング

`mastra start`または`mastra dev`コマンドを使用する場合、Mastraは自動的にトレーシングに必要なインストルメンテーションファイルをプロビジョニングし、ロードします。ただし、独自のアプリケーション（Mastraサーバー環境外）でMastraを依存関係として使用する場合は、手動でインストルメンテーションファイルを提供する必要があります。

この場合にトレーシングを有効にするには：

1. 設定でMastraテレメトリを有効にします：

```typescript
export const mastra = new Mastra({
  telemetry: {
    enabled: true,
  },
});
```

2. プロジェクトにインストルメンテーションファイル（例：`instrumentation.mjs`）を作成します：



```typescript
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter(),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();
```

3. OpenTelemetry環境変数を追加します：

```bash
OTEL_EXPORTER_OTLP_ENDPOINT=https://api.braintrust.dev/otel
OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer <Your API Key>, x-bt-parent=project_name:<Your Project Name>"
```

4. アプリケーションの前にOpenTelemetry SDKを実行します：

```bash
node --import=./instrumentation.mjs --import=@opentelemetry/instrumentation/hook.mjs src/index.js
```

### Next.js固有のトレーシング手順

Next.jsを使用している場合、3つの追加設定手順があります：

1. `next.config.ts`でinstrumentationフックを有効にする
2. Mastraテレメトリ設定を構成する
3. OpenTelemetryエクスポーターを設定する

実装の詳細については、[Next.jsトレーシング](./nextjs-tracing)ガイドを参照してください。
